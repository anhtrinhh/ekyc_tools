<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./dist/ekyc-tools.min.js"></script>
    <link rel="stylesheet" href="css/ekyct.css">
    <style>
        h1 {
            margin: 0;
        }
    </style>
</head>

<body>
    <p>
        <img style="width: 450px;" id="img-id">
    </p>
    <p>
        <video style="width: 450px;" id="video-id"></video>
    </p>
    <button onclick="handleCapture()">Take photo</button>
    <button onclick="handleRecord()">Take video</button>
    <script>
        function removeAccent(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        }
        async function getCameraDevicesByType() {
            const cameraDevices = await EkycTools.getCameraDevices();
            const others = [];
            const backs = [];
            const fronts = [];
            for (let i = 0; i < cameraDevices.length; i++) {
                const device = cameraDevices[i];
                const label = removeAccent(device.label).toLowerCase();
                if (/(rear|back|sau)/.test(label) && !/(tele|ultra|dual|triple|chup|xa|cuc|rong|kep)/.test(label) && !/^(hai|ba)\s/.test(label)) {
                    if (backs.length === 0) backs.push(device);
                    else {
                        if (label.includes('0')) {
                            others.push(backs[0]);
                            backs[0] = device;
                        } else others.push(device);
                    }
                } else if (/(front|truoc)/.test(label) && !/(tele|ultra|dual|triple|chup|xa|cuc|rong|kep)/.test(label) && !/^(hai|ba)\s/.test(label)) {
                    if (fronts.length === 0) fronts.push(device);
                    else {
                        if (label.includes('1')) {
                            others.push(fronts[0]);
                            fronts[0] = device;
                        } else others.push(device);
                    }
                } else others.push(device);
            }
            return {
                backs,
                fronts,
                others
            };
        }
        async function handleRecord() {
            var tools = new EkycTools();
            tools.open({
                video: { aspectRatio: 1, width: 1440, height: 1080 }, shadingRatio: 0, zoom: 1, canvasMaxWidth: 0, canvasMinWidth: 0, recordMs: 8000,
                onError: reason => console.log(reason),
                onStart: () => console.log('Start capture'),
                onStop: rs => {
                    console.log(rs)
                    if (rs) {
                        alert(JSON.stringify(rs))
                        
                        const videoEl = document.getElementById('video-id');
                        const url = URL.createObjectURL(rs.blob);
                        videoEl.controls = true;
                        videoEl.muted = true;
                        videoEl.src = url;
                        videoEl.onload = () => {
                            URL.revokeObjectURL(url);
                        };

                        const img = document.getElementById('img-id');
                        const imgUrl = URL.createObjectURL(rs.poster.blob);
                        img.src = imgUrl;
                        img.onload = () => {
                            URL.revokeObjectURL(imgUrl);
                        };

                        tools.close();
                    }
                }
            });
        }

        async function handleCapture() {
            getCameraDevicesByType().then(rs => {
                let deviceId;
                if (rs.backs.length > 0) deviceId = rs.backs[0].id;
                else if (rs.others.length > 0) deviceId = rs.others[0].id;
                var tools = new EkycTools(true);
                tools.open({
                    enableFilePicker: true, enableSwitchCamera: true, enableFlash: true, zoom: 1,
                    video: { width: 1920, height: 1080, deviceId }, shadingRatio: 1.66666667, canvasMaxWidth: 1920, canvasMinWidth: 1280,
                    onError: reason => console.log(reason),
                    onStart: () => console.log('Start capture'),
                    onStop: rs => {
                        if (rs) {
                            alert(JSON.stringify(rs))
                            const img = document.getElementById('img-id');
                            const url = URL.createObjectURL(rs.blob);
                            img.src = url;
                            img.onload = () => {
                                URL.revokeObjectURL(url);
                            };
                            tools.close();
                        }
                    }
                });
            })
        }
    </script>
</body>

</html>